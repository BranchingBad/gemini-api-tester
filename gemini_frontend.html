<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini API Tester</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Style for response text output */
        .response-text {
            white-space: pre-wrap; /* Preserve whitespace and handle wrapping */
            word-wrap: break-word;
            line-height: 1.5;
        }
        /* Custom modal for alerts */
        #customAlert {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(-20px);
        }
        #customAlert.show {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4 sm:p-6">
    <div class="bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-4xl border border-gray-200">
        <header class="text-center mb-6 sm:mb-8">
            <h1 class="text-3xl font-bold text-gray-800">Gemini API Tester</h1>
            <p class="text-gray-500 mt-1">A simple Flask & JavaScript interface</p>
        </header>
        
        <div class="space-y-6">
            
            <div>
                <label for="modelSelect" class="block text-sm font-medium text-gray-700 mb-2">Select Gemini Model:</label>
                <select id="modelSelect" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border">
                    <option value="gemini-2.5-flash">gemini-2.5-flash (Fast, General, Multimodal)</option>
                    <option value="gemini-2.5-pro">gemini-2.5-pro (Advanced Reasoning, Multimodal)</option>
                    <option value="gemini-2.5-flash-lite">gemini-2.5-flash-lite (Fastest, Text Only)</option>
                    <option value="imagen-3.0-generate-002">imagen-3.0-generate-002 (Image Generation)</option>
                </select>
            </div>
            
            <div>
                <label for="promptInput" class="block text-sm font-medium text-gray-700 mb-2">Enter Prompt:</label>
                <textarea id="promptInput" rows="5" class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-3 border" placeholder="e.g., Explain the concept of quantum entanglement in simple terms."></textarea>
            </div>

            <div id="imageInputContainer" class="hidden">
                <label for="imageInput" class="block text-sm font-medium text-gray-700 mb-2">Image Input (Optional for Gemini, Required for Imagen):</label>
                <input type="file" id="imageInput" accept="image/*" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100"/>
                <p id="imagePreviewText" class="text-xs text-gray-500 mt-2 italic">No image selected.</p>
            </div>
            
            <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="submitButton" class="w-full sm:w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    <span id="buttonText">Send to Gemini</span>
                    <span id="loadingSpinner" class="hidden h-5 w-5 border-2 border-t-2 border-white border-opacity-30 rounded-full animate-spin ml-2 inline-block"></span>
                </button>
                <button id="copyButton" class="w-full sm:w-1/2 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-3 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50" disabled>
                    Copy Response
                </button>
            </div>
            
            <div class="pt-4 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Response:</h3>
                <div id="responseContainer" class="bg-gray-50 p-4 rounded-lg border border-gray-200 min-h-[100px]">
                    <p id="responseText" class="response-text text-gray-800">Awaiting your prompt...</p>
                    <div id="responseImage" class="mt-4 hidden max-w-full">
                        <img id="generatedImage" src="" alt="Generated Image" class="rounded-lg shadow-lg mx-auto" />
                    </div>
                </div>
                <p class="text-sm text-gray-500 mt-2">Time taken: <span id="durationTime" class="font-medium">0.00s</span></p>
            </div>

            <div id="customAlert" class="px-4 py-3 rounded-lg shadow-xl text-white"></div>
        </div>
    </div>

    <script>
        (function() {
            const modelSelect = document.getElementById('modelSelect');
            const promptInput = document.getElementById('promptInput');
            const submitButton = document.getElementById('submitButton');
            const buttonText = document.getElementById('buttonText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const responseText = document.getElementById('responseText');
            const durationTime = document.getElementById('durationTime');
            const copyButton = document.getElementById('copyButton');
            const imageInputContainer = document.getElementById('imageInputContainer');
            const imageInput = document.getElementById('imageInput');
            const imagePreviewText = document.getElementById('imagePreviewText');
            const responseImage = document.getElementById('responseImage');
            const generatedImage = document.getElementById('generatedImage');

            // --- UI State Management ---
            const toggleLoadingState = (isLoading) => {
                submitButton.disabled = isLoading;
                promptInput.disabled = isLoading;
                modelSelect.disabled = isLoading;
                imageInput.disabled = isLoading;
                copyButton.disabled = isLoading || responseText.textContent.trim() === 'Awaiting your prompt...' || responseText.textContent.trim().startsWith('Error');
                
                if (isLoading) {
                    buttonText.textContent = 'Processing...';
                    loadingSpinner.classList.remove('hidden');
                    responseText.textContent = 'Generating response...';
                    durationTime.textContent = '0.00s';
                    responseImage.classList.add('hidden');
                } else {
                    buttonText.textContent = 'Send to Gemini';
                    loadingSpinner.classList.add('hidden');
                }
            };

            const checkInputs = () => {
                // Enable button if prompt is not empty
                submitButton.disabled = promptInput.value.trim() === '';
            };

            const handleModelChange = () => {
                const selectedModel = modelSelect.value;
                const isImageModel = selectedModel === 'imagen-3.0-generate-002'; // Updated Image Model ID
                const isMultimodalModel = selectedModel === 'gemini-2.5-flash' || selectedModel === 'gemini-2.5-pro'; // Multimodal chat models
                
                // Show the image input container if it's an image generation model OR a multimodal chat model
                if (isImageModel || isMultimodalModel) {
                    imageInputContainer.classList.remove('hidden');
                } else {
                    imageInputContainer.classList.add('hidden');
                    imageInput.value = ''; // Clear file selection for text-only models
                    imagePreviewText.textContent = 'No image selected.';
                }
                
                // Update placeholder text based on the model
                if (isImageModel) {
                    promptInput.placeholder = "e.g., A golden retriever wearing a space suit, digital art style.";
                } else if (isMultimodalModel) {
                    promptInput.placeholder = "e.g., Describe the image you provided or ask a question about it.";
                } else {
                    promptInput.placeholder = "e.g., Explain the concept of quantum entanglement in simple terms.";
                }
            };
            
            const handleImageSelect = () => {
                if (imageInput.files.length > 0) {
                    imagePreviewText.textContent = imageInput.files[0].name;
                } else {
                    imagePreviewText.textContent = 'No image selected.';
                }
            };

            // Initial checks
            checkInputs();
            handleModelChange();

            // Event Listeners
            promptInput.addEventListener('input', checkInputs);
            modelSelect.addEventListener('change', handleModelChange);
            imageInput.addEventListener('change', handleImageSelect);
            copyButton.onclick = () => copyTextToClipboard(responseText.textContent);

            // --- API Call Logic ---
            submitButton.onclick = async () => {
                const prompt = promptInput.value.trim();
                const selectedModel = modelSelect.value;
                const imageFile = imageInput.files[0];
                let imageBase64 = null;
                
                if (prompt === '') {
                    showCustomAlert("Warning!", "Please enter a prompt.", 'bg-yellow-500');
                    return;
                }

                toggleLoadingState(true);

                try {
                    const startTime = performance.now();
                    
                    // 1. Handle image file conversion if present
                    if (imageFile) {
                        const fileReader = new FileReader();
                        // Wait for file reading to complete
                        await new Promise((resolve, reject) => {
                            fileReader.onload = (event) => {
                                // Extract base64 part (data:image/jpeg;base64,...)
                                imageBase64 = event.target.result.split(',')[1];
                                resolve();
                            };
                            fileReader.onerror = reject;
                            fileReader.readAsDataURL(imageFile);
                        });
                    }

                    // 2. Make the API Call
                    const response = await fetch('/gemini_call', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ 
                            prompt, 
                            model: selectedModel,
                            image_base64: imageBase64
                        }),
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    
                    // 3. Process the response
                    if (data.result_type === 'image') {
                        // Handle Image Generation Result
                        responseText.textContent = `Image generated successfully for prompt: "${prompt}"`;
                        generatedImage.src = `data:image/jpeg;base64,${data.image_base64}`;
                        responseImage.classList.remove('hidden');
                    } else {
                        // Handle Text Generation Result
                        responseText.textContent = data.result || 'No response text received.';
                        responseImage.classList.add('hidden');
                    }

                    durationTime.textContent = data.duration || 'N/A';
                    showCustomAlert("Success!", "Response received.", 'bg-green-500');

                } catch (error) {
                    console.error('Fetch Error:', error);
                    responseText.textContent = `Error: ${error.message}. Check the server logs (app.py) or ensure the server is running.`;
                    durationTime.textContent = 'N/A';
                    responseImage.classList.add('hidden');
                    showCustomAlert("Error!", "Failed to get response.", 'bg-red-500');
                } finally {
                    toggleLoadingState(false);
                }
            };
            
            // --- Utility Functions ---
            function showCustomAlert(title, message, bgColor = 'bg-blue-500') {
                const alertElement = document.getElementById('customAlert');
                alertElement.innerHTML = `<strong>${title}</strong> ${message}`;
                // Reset classes before adding new ones
                alertElement.className = 'px-4 py-3 rounded-lg shadow-xl text-white';
                alertElement.classList.add(bgColor, 'show');

                setTimeout(() => {
                    alertElement.classList.remove('show');
                }, 3000); // Alert disappears after 3 seconds
            }

            function copyTextToClipboard(textToCopy) {
                // Use modern Clipboard API first
                if (navigator.clipboard && window.isSecureContext) {
                    navigator.clipboard.writeText(textToCopy).then(() => {
                        showCustomAlert("Success!", "Response copied to clipboard.");
                    }).catch(err => {
                        console.error('Failed to copy text using clipboard API: ', err);
                        // Fallback to old method if modern one fails
                        fallbackCopyTextToClipboard(textToCopy);
                    });
                } else {
                    fallbackCopyTextToClipboard(textToCopy);
                }
            }
            
            function fallbackCopyTextToClipboard(text) {
                const tempTextArea = document.createElement("textarea");
                tempTextArea.value = text;
                // Avoid scrolling to bottom of page in Windows
                tempTextArea.style.position = 'fixed';
                tempTextArea.style.top = 0;
                tempTextArea.style.left = 0;
                document.body.appendChild(tempTextArea);
                tempTextArea.focus();
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showCustomAlert("Success!","Response copied to clipboard (fallback).");
                } catch (err) {
                    showCustomAlert("Copy Failed", "Failed to copy text. Please try again.");
                } finally {
                    document.body.removeChild(tempTextArea);
                }
            }
        })();
    </script>
</body>
</html>